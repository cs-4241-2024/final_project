var p=Object.defineProperty;var S=(s,t,e)=>t in s?p(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var n=(s,t,e)=>S(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))o(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(r){if(r.ep)return;r.ep=!0;const i=e(r);fetch(r.href,i)}})();const f={Square:[[1,1],[1,1]],T:[[0,2,0],[2,2,2]],L:[[0,0,3],[3,3,3]],J:[[4,0,0],[4,4,4]],S:[[0,5,5],[5,5,0]],Z:[[6,6,0],[0,6,6]],line:[[7],[7],[7],[7]]};class w{constructor(t){n(this,"COLS");n(this,"ROWS");n(this,"SIZE");n(this,"ctx");n(this,"board");n(this,"tetromino");n(this,"row");n(this,"column");n(this,"colors");n(this,"gameOver");n(this,"score");this.COLS=10,this.ROWS=20,this.SIZE=25,this.ctx=t,this.ctx.canvas.width=this.COLS*this.SIZE,this.ctx.canvas.height=this.ROWS*this.SIZE,this.ctx.scale(this.SIZE,this.SIZE),this.tetromino=null,this.row=0,this.column=0,this.board=this.emptyBoard(),this.colors=["white","red","blue","green","yellow","purple","orange","cyan"],this.gameOver=!1,this.score=0}emptyBoard(){let t=[];for(let e=0;e<this.ROWS;e++){t[e]=[];for(let o=0;o<this.COLS;o++)t[e][o]=0}return t}drawBoard(){for(let t=0;t<this.board.length;t++)for(let e=0;e<this.board[t].length;e++)this.ctx.fillStyle=this.colors[this.board[t][e]],this.ctx.fillRect(e,t,1,1),this.ctx.lineWidth=.02,this.ctx.strokeStyle="black",this.ctx.strokeRect(e,t,1,1);this.tetromino||(this.tetromino=this.randomTetromino()),this.drawTetromino()}drawTetromino(){if(this.tetromino)for(let t=0;t<this.tetromino.length;t++)for(let e=0;e<this.tetromino[t].length;e++)this.tetromino[t][e]!==0&&(this.ctx.fillStyle=this.colors[this.tetromino[t][e]],this.ctx.fillRect(e+this.column,t+this.row,1,1),this.ctx.lineWidth=.02,this.ctx.strokeStyle="black",this.ctx.strokeRect(e+this.column,t+this.row,1,1))}moveRight(){this.column++,this.collision()&&this.column--}moveLeft(){this.column--,this.collision()&&this.column++}moveDown(){if(this.row++,this.collision()){if(this.row--,this.placeTetromino(),this.tetromino=this.randomTetromino(),this.checkGameOver()){this.gameOver=!0;const t=document.getElementById("score");try{fetch("/submit-score",{method:"POST",headers:{"Content-Type":"application/json",Authorization:localStorage.getItem("token")},body:JSON.stringify({username:localStorage.getItem("username"),score:t.textContent})})}catch(e){console.error("Submit score error:",e)}this.showGameOver()}this.row=0,this.column=4}}rotate(){if(!this.tetromino)return;let t=[];for(let o=0;o<this.tetromino[0].length;o++){t[o]=[];for(let r=0;r<this.tetromino.length;r++)t[o][r]=this.tetromino[this.tetromino.length-1-r][o]}let e=this.tetromino;this.tetromino=t,this.collision()&&(this.tetromino=e)}collision(){if(this.tetromino){for(let t=0;t<this.tetromino.length;t++)for(let e=0;e<this.tetromino[t].length;e++)if(this.tetromino[t][e]!==0&&(t+this.row===this.ROWS||e+this.column===this.COLS||e+this.column<0||this.board[t+this.row][e+this.column]!==0))return!0}return!1}placeTetromino(){if(this.tetromino)for(let t=0;t<this.tetromino.length;t++)for(let e=0;e<this.tetromino[t].length;e++)this.tetromino[t][e]!==0&&(this.board[t+this.row][e+this.column]=this.tetromino[t][e]);this.checkRows()}checkRows(){for(let t=0;t<this.ROWS;t++)for(let e=0;e<this.COLS&&this.board[t][e]!==0;e++)if(e===this.COLS-1){this.board.splice(t,1),this.board.unshift(Array(this.COLS).fill(0));const o=document.getElementById("score");o&&(o.textContent=(parseInt(o.textContent)+1e3).toString())}}checkGameOver(){if(this.tetromino){for(let t=0;t<this.tetromino.length;t++)for(let e=0;e<this.tetromino[t].length;e++)if(this.tetromino[t][e]!==0&&this.board[t][e+this.column]!==0)return!0}return!1}randomTetromino(){const t=Object.keys(f),e=t[Math.floor(Math.random()*t.length)];return this.tetromino=f[e],this.row=0,this.column=4,this.tetromino}showGameOver(){this.ctx.fillStyle="black",this.ctx.font="1px Arial",this.ctx.fillText("Game Over",3,10);const t=localStorage.getItem("username");t&&this.submitScore(t,this.score);const e=document.createElement("button");e.innerText="Restart",e.style.position="relative",e.style.marginTop="20px",document.body.appendChild(e),e.addEventListener("click",()=>{document.body.removeChild(e),this.resetGame(),e.remove()})}async submitScore(t,e){try{const r=await(await fetch("/api/submit-score",{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+localStorage.getItem("token")},body:JSON.stringify({username:t,score:e})})).json();console.log("Score submitted:",r)}catch(o){console.error("Error submitting score:",o)}}resetGame(){this.board=this.emptyBoard(),this.tetromino=this.randomTetromino(),this.row=0,this.column=4,this.gameOver=!1,this.score=0}getScore(){return this.score}}const a=document.getElementById("login-form"),d=document.getElementById("register-form"),O=document.querySelector(".tutorial-container"),h=document.getElementById("login-message"),m=document.getElementById("register-message"),b=document.getElementById("game-container"),v=document.getElementById("leaderboard-button");a.addEventListener("submit",async s=>{s.preventDefault();const t=document.getElementById("username").value,e=document.getElementById("password").value;try{const o=await fetch("/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})});if(o.ok){const r=await o.json();localStorage.setItem("token",r.token),h.textContent="",a.reset(),a.style.display="none",O.style.display="none",d.style.display="none",b.style.display="block";const i=document.getElementById("score-container");i.style.display="block",x()}else{const r=await o.text();h.textContent=r}}catch(o){h.textContent="An error occurred during login",console.error("Login error:",o)}});d.addEventListener("submit",async s=>{s.preventDefault();const t=document.getElementById("new-username").value,e=document.getElementById("new-password").value;try{const o=await fetch("/register",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:t,password:e})});if(o.ok)m.textContent="",d.reset();else{const r=await o.text();m.textContent=r}}catch(o){m.textContent="An error occurred during registering",console.error("Registering error:",o)}});v.addEventListener("click",async()=>{try{const s=await fetch("/leaderboard.html");if(s.ok)window.location.href="/leaderboard.html",console.log("ok");else{const t=await s.text();console.error("Leaderboard error:",t)}}catch(s){console.error("Leaderboard error:",s)}});function x(){const i=document.getElementById("tetris").getContext("2d");i.canvas.width=10*25,i.canvas.height=20*25,i.scale(25,25);let c=new w(i);g(c),document.addEventListener("keydown",l=>{c.gameOver||(l.key==="ArrowRight"&&c.moveRight(),l.key==="ArrowLeft"&&c.moveLeft(),l.key==="ArrowDown"&&c.moveDown(),l.key==="ArrowUp"&&c.rotate())});function g(l){l.drawBoard();let y=0;u();function u(){l.drawBoard(),requestAnimationFrame(u),!l.gameOver&&++y%40===0&&(l.moveDown(),document.getElementById("score").innerText=l.getScore().toString())}}}
